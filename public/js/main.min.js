'use strict';

class Card {
	constructor() {
		this._cards = Array.from(document.querySelectorAll('.card'));
		this._is_liked = 'card__button_is-liked';
		this._is_disliked = 'card__button_is-disliked';
		this._svg_liked = 'svg__card_is-liked';
		this._svg_disliked = 'svg__card_is-disliked';

		this._addEventListener();
	}

	_addEventListener() {
		this._cards.forEach(card => {
			const the_buttons = Array.from(card.querySelectorAll('.card__button'));
			
			this._handleCard(the_buttons, card);
		});
	}

	_handleCard(buttons, card) {
		buttons.forEach(button => {
			button.addEventListener('click', _ => this._toggleCardButton(button, buttons, card));
		});
	}

	_toggleCardButton(current_button, buttons, card) {
		if (current_button.classList.contains('card__button_dislike')) {
			this._removeCard(current_button, card, 'disliked');
		} else if (current_button.classList.contains('card__button_like')) {
			this._removeCard(current_button, card, 'liked');
		} else {
			this._removeCard(current_button, card);
		}
	}

	_removeCard(button, card, status) {
		const url = button.getAttribute('data-href');

		if (status === 'liked') this._cardStatus(url, card, status);
		else if (status === 'disliked') this._cardStatus(url, card, undefined, status);
		else this._cardStatus(url, card);

		card.classList.add('card__is-removed');
		setTimeout(_ => card.classList.add('hidden'), 400);
	}

	_cardStatus(url, card, like, disliked) {
		const id = card.getAttribute('data-shop');
		const user_id = card.getAttribute('data-user');
		const data = {
			'id': id,
			'like': like || undefined,
			'disliked': disliked || undefined,
			'user_id': user_id
		}

		const options = {
			method: 'PUT',
			body: JSON.stringify(data),
			headers: {'content-type': 'application/json'}
		};

		fetch(url, options)
			.then(res => res.json())
			.then(response => console.log(response))
			.catch(err => console.log(err));
	}
}

new Card();
'use strict';

class CardOffline {
    constructor() {
        this._cards = Array.from(document.querySelectorAll('.card'));
        this._is_liked = 'card__button_is-liked';
        this._is_disliked = 'card__button_is-disliked';
        this._svg_liked = 'svg__card_is-liked';
        this._svg_disliked = 'svg__card_is-disliked';

        this._addEventListener();
    }

    _addEventListener() {
        this._cards.forEach(card => {
            const the_buttons = Array.from(card.querySelectorAll('.card__button'));
            
            this._handleCard(the_buttons, card);
        });
    }

    _handleCard(buttons, card) {
        buttons.forEach(button => {
            button.addEventListener('click', _ => this._toggleCardButton(button, card));
        });
    }

    _toggleCardButton(current_button, card) {
        if (current_button.classList.contains('card__button_dislike')) {
            this._addToStorage(current_button, card, 'disliked');
        } else if (current_button.classList.contains('card__button_like')) {
            this._addToStorage(current_button, card, 'liked');
        } else {
            this._addToStorage(current_button, card);
        }
    }

    _addToStorage(button, card, stat) {
        const url = button.getAttribute('data-href');
        const card_id = card.getAttribute('data-shop');
        const user_id = card.getAttribute('data-user');
        
        const likes = new likesDB();

        likes.set({
            'id': card_id,
            'user_id': user_id,
            'stat': stat,
            'url': url
        });
    }
}
'use strict';

class Filter {
	constructor() {
		this._buttons = Array.from(document.querySelectorAll('.filter__button'));
		this._active = 'filter__button_active';

		this._addEventListener();
	}

	_addEventListener() {
		this._buttons.forEach(button => {
			button.addEventListener('click', _ => this._activateButton(button));
		});
	}

	_activateButton(current_button) {
		if (current_button.classList.contains(this._active)) return;

		//disactivate the other buttons.
		current_button.classList.add(this._active);
		this._buttons.forEach(button => {
			if (button !== current_button) button.classList.remove(this._active);
		});
	}
}

new Filter();
'use strict';

class likesDB {
    constructor() {
        this._db = new Dexie('MyDatabase');
        this._db.version(1).stores({likes: '++db_id, id, user_id, like, disliked, url'});
    }

    set(obj) {
        this._db.open().then(_ => {
            return this._db.likes.add({
                id: obj.id,
                user_id: obj.user_id,
                like: (obj.stat === 'liked') ? obj.stat : undefined,
                disliked: (obj.stat === 'disliked') ? obj.stat : undefined,
                url: obj.url
            });
        });
    }

    get() {
        this._db.open()
            .then(_ => this._db.likes.toArray())
            .then(likes => likes)
            .then(results => {
                if (!results) return;
                
                results.forEach(result => {
                    const data = {
                        'id': result.id,
                        'like': result.like || undefined,
                        'disliked': result.disliked || undefined,
                        'user_id': result.user_id
                    };

                    const options = {
                        method: 'PUT',
                        body: JSON.stringify(data),
                        headers: {'content-type': 'application/json'}
                    };

                    fetch(result.url, options)
                        .then(res => res.json())
                        .then(response => console.log(response))
                        .catch(err => console.log(err));
                });
            })
            .then(_ => this._db.likes.clear());
    }

    clear() {
        this._db.open().then(_ => this._db.clear());
    }
}
'use strict';

class FetchPage {
    constructor() {
        this._triggers = Array.from(document.querySelectorAll('.fetch'));
        this._tabs = Array.from(document.querySelectorAll('.nav__tab'));
        this._container = document.querySelector('.main');
        this._tmp_container = document.querySelector('.tmp');
        this._loader = document.querySelector('.loader');
        this._cards = Array.from(document.querySelectorAll('.card'));

        this._addEventListener();
        this._refresh(this._cards);
    }

    _addEventListener() {
        this._triggers.forEach(trigger => {
            trigger.addEventListener('click', event => this._getPage(event));
        });
    }

    _getPage(event) {
        event.preventDefault();
        this._loader.classList.remove('hidden');

        const trigger = event.target
        const url = trigger.href;
        const options = {credentials: "same-origin"}

        fetch(url, options)
            .then(res => res.text())
            .then(response => {
                this._tmp_container.innerHTML = response;

                this._render(this._tmp_container);
                this._loader.classList.add('hidden');

                this._setTab(this._tabs, trigger);
            })
            .catch(err => console.log(err));
    }

    _render(tmp) {
        const content = tmp.querySelector('.main');
        this._container.innerHTML = "";
        this._container.appendChild(content);
        this._container.classList.add('page__is-added');

        setTimeout(_ => this._container.classList.remove('page__is-added'), 400);
        new Card();
    }

    _setTab(tabs, current_tab) {
        if (current_tab.classList.contains('nav__tab')) {
            current_tab.classList.add('nav__tab_current');
            tabs.forEach(tab => {
                if (tab !== current_tab) tab.classList.remove('nav__tab_current')
            });
        }
    }

    _refresh(cards) {
        if (cards.length === 0) {
            fetch('/')
                .then(res => res.text())
                .then(response => {
                    this._loader.classList.remove('hidden');
                    this._tmp_container.innerHTML = response;

                    this._render(this._tmp_container);
                    this._loader.classList.add('hidden');
                });
        }
    }
}

new FetchPage();
'use strict';

class Menu {
    constructor() {
        this.showButtonEl = document.querySelector('.js-menu-show');
        this.hideButtonEl = document.querySelector('.js-menu-hide');
        this.sideNavEl = document.querySelector('.js-side-nav');
        this.sideNavContainerEl = document.querySelector('.js-side-nav-container');

        this.showSideNav = this.showSideNav.bind(this);
        this.hideSideNav = this.hideSideNav.bind(this);
        this.blockClicks = this.blockClicks.bind(this);
        this.onTouchStart = this.onTouchStart.bind(this);
        this.onTouchMove = this.onTouchMove.bind(this);
        this.onTouchEnd = this.onTouchEnd.bind(this);
        this.onTransitionEnd = this.onTransitionEnd.bind(this);
        this.update = this.update.bind(this);

        this.startX = 0;
        this.currentX = 0;
        this.touchingSideNav = false;

        this.transitionEndProperty = null;
        this.transitionEndTime = 0;

        this.supportsPassive = undefined;
        this._addEventListeners();
    }

    applyPassive() {
        if (this.supportsPassive !== undefined) {
            return this.supportsPassive ? { passive: true } : false;
        }
        
        let isSupported = false;
        try {
            document.addEventListener('test', null, {
                get passive() {
                    isSupported = true;
                }
            });
        } catch (e) { }
        this.supportsPassive = isSupported;
        return this.applyPassive();
    }

    _addEventListeners() {
        this.showButtonEl.addEventListener('click', this.showSideNav);
        this.hideButtonEl.addEventListener('click', this.hideSideNav);
        this.sideNavEl.addEventListener('click', this.hideSideNav);
        this.sideNavContainerEl.addEventListener('click', this.blockClicks);

        this.sideNavEl.addEventListener('touchstart', this.onTouchStart, this.applyPassive());
        this.sideNavEl.addEventListener('touchmove', this.onTouchMove, this.applyPassive());
        this.sideNavEl.addEventListener('touchend', this.onTouchEnd);
    }

    onTouchStart(evt) {
        if (!this.sideNavEl.classList.contains('side-nav--visible'))
            return;

        this.startX = evt.touches[0].pageX;
        this.currentX = this.startX;

        this.touchingSideNav = true;
        requestAnimationFrame(this.update);
    }

    onTouchMove(evt) {
        if (!this.touchingSideNav)
            return;

        this.currentX = evt.touches[0].pageX;
    }

    onTouchEnd(evt) {
        if (!this.touchingSideNav)
            return;

        this.touchingSideNav = false;

        const translateX = Math.min(0, this.currentX - this.startX);
        this.sideNavContainerEl.style.transform = '';

        if (translateX < 0) {
            this.hideSideNav();
        }
    }

    update() {
        if (!this.touchingSideNav)
            return;

        requestAnimationFrame(this.update);

        const translateX = Math.min(0, this.currentX - this.startX);
        this.sideNavContainerEl.style.transform = `translateX(${translateX}px)`;
    }

    blockClicks(evt) {
        evt.stopPropagation();
    }

    onTransitionEnd(evt) {
        if (evt.propertyName != this.transitionEndProperty && evt.elapsedTime != this.transitionEndTime) {
            return;
        }

        this.transitionEndProperty = null;
        this.transitionEndTime = 0;

        this.sideNavEl.classList.remove('side-nav--animatable');
        this.sideNavEl.removeEventListener('transitionend', this.onTransitionEnd);
    }

    showSideNav() {
        this.sideNavEl.classList.add('side-nav--animatable');
        this.sideNavEl.classList.add('side-nav--visible');

        this.transitionEndProperty = 'transform';
        this.transitionEndTime = 0.33;

        this.sideNavEl.addEventListener('transitionend', this.onTransitionEnd);
    }

    hideSideNav() {
        this.sideNavEl.classList.add('side-nav--animatable');
        this.sideNavEl.classList.remove('side-nav--visible');

        this.transitionEndProperty = 'transform';
        this.transitionEndTime = 0.13;

        this.sideNavEl.addEventListener('transitionend', this.onTransitionEnd);
    }
}

new Menu();
'use strict';

if ('serviceWorker' in navigator) {
    addEventListener('load', function () {
        navigator.serviceWorker.register(
            '/sw.js', { scope: '.' }
        );
    });
}

let lock = false;

if (navigator.onLine) addEventListener('online', _ => appOnline());
else appOffline();

addEventListener('offline', _ => appOffline());
addEventListener('online', _ => appOnline());

function appOnline() {
    document.body.classList.remove('offline');

    if (lock) {
        const likes = new likesDB();
        likes.get();
        lock = false;
    } else {
        lock = true;
    }
}

function appOffline() {
    document.body.classList.add('offline');
    Array.from(document.querySelectorAll('a')).forEach(link => {
        linkIsAvailableOffline(link).then(res => {
            if (res) link.classList.add('cached');
        });
    });

    new CardOffline();
}

function linkIsAvailableOffline(link) {
    const url = link.href;
    return caches.match(url)
        .then(res => {
            if (res) {
                if (res.status === 200) return true;
            }
        });
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL2NhcmQuanMiLCJqcy9jYXJkX29mZmxpbmUuanMiLCJqcy9maWx0ZXIuanMiLCJqcy9pbmRleGRiLmpzIiwianMvbWFpbi5qcyIsImpzL21lbnUuanMiLCJqcy9zZXJ2aWNlX3dvcmtlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN2RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDckRBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM1RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Im1haW4ubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jbGFzcyBDYXJkIHtcblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0dGhpcy5fY2FyZHMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5jYXJkJykpO1xuXHRcdHRoaXMuX2lzX2xpa2VkID0gJ2NhcmRfX2J1dHRvbl9pcy1saWtlZCc7XG5cdFx0dGhpcy5faXNfZGlzbGlrZWQgPSAnY2FyZF9fYnV0dG9uX2lzLWRpc2xpa2VkJztcblx0XHR0aGlzLl9zdmdfbGlrZWQgPSAnc3ZnX19jYXJkX2lzLWxpa2VkJztcblx0XHR0aGlzLl9zdmdfZGlzbGlrZWQgPSAnc3ZnX19jYXJkX2lzLWRpc2xpa2VkJztcblxuXHRcdHRoaXMuX2FkZEV2ZW50TGlzdGVuZXIoKTtcblx0fVxuXG5cdF9hZGRFdmVudExpc3RlbmVyKCkge1xuXHRcdHRoaXMuX2NhcmRzLmZvckVhY2goY2FyZCA9PiB7XG5cdFx0XHRjb25zdCB0aGVfYnV0dG9ucyA9IEFycmF5LmZyb20oY2FyZC5xdWVyeVNlbGVjdG9yQWxsKCcuY2FyZF9fYnV0dG9uJykpO1xuXHRcdFx0XG5cdFx0XHR0aGlzLl9oYW5kbGVDYXJkKHRoZV9idXR0b25zLCBjYXJkKTtcblx0XHR9KTtcblx0fVxuXG5cdF9oYW5kbGVDYXJkKGJ1dHRvbnMsIGNhcmQpIHtcblx0XHRidXR0b25zLmZvckVhY2goYnV0dG9uID0+IHtcblx0XHRcdGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIF8gPT4gdGhpcy5fdG9nZ2xlQ2FyZEJ1dHRvbihidXR0b24sIGJ1dHRvbnMsIGNhcmQpKTtcblx0XHR9KTtcblx0fVxuXG5cdF90b2dnbGVDYXJkQnV0dG9uKGN1cnJlbnRfYnV0dG9uLCBidXR0b25zLCBjYXJkKSB7XG5cdFx0aWYgKGN1cnJlbnRfYnV0dG9uLmNsYXNzTGlzdC5jb250YWlucygnY2FyZF9fYnV0dG9uX2Rpc2xpa2UnKSkge1xuXHRcdFx0dGhpcy5fcmVtb3ZlQ2FyZChjdXJyZW50X2J1dHRvbiwgY2FyZCwgJ2Rpc2xpa2VkJyk7XG5cdFx0fSBlbHNlIGlmIChjdXJyZW50X2J1dHRvbi5jbGFzc0xpc3QuY29udGFpbnMoJ2NhcmRfX2J1dHRvbl9saWtlJykpIHtcblx0XHRcdHRoaXMuX3JlbW92ZUNhcmQoY3VycmVudF9idXR0b24sIGNhcmQsICdsaWtlZCcpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLl9yZW1vdmVDYXJkKGN1cnJlbnRfYnV0dG9uLCBjYXJkKTtcblx0XHR9XG5cdH1cblxuXHRfcmVtb3ZlQ2FyZChidXR0b24sIGNhcmQsIHN0YXR1cykge1xuXHRcdGNvbnN0IHVybCA9IGJ1dHRvbi5nZXRBdHRyaWJ1dGUoJ2RhdGEtaHJlZicpO1xuXG5cdFx0aWYgKHN0YXR1cyA9PT0gJ2xpa2VkJykgdGhpcy5fY2FyZFN0YXR1cyh1cmwsIGNhcmQsIHN0YXR1cyk7XG5cdFx0ZWxzZSBpZiAoc3RhdHVzID09PSAnZGlzbGlrZWQnKSB0aGlzLl9jYXJkU3RhdHVzKHVybCwgY2FyZCwgdW5kZWZpbmVkLCBzdGF0dXMpO1xuXHRcdGVsc2UgdGhpcy5fY2FyZFN0YXR1cyh1cmwsIGNhcmQpO1xuXG5cdFx0Y2FyZC5jbGFzc0xpc3QuYWRkKCdjYXJkX19pcy1yZW1vdmVkJyk7XG5cdFx0c2V0VGltZW91dChfID0+IGNhcmQuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyksIDQwMCk7XG5cdH1cblxuXHRfY2FyZFN0YXR1cyh1cmwsIGNhcmQsIGxpa2UsIGRpc2xpa2VkKSB7XG5cdFx0Y29uc3QgaWQgPSBjYXJkLmdldEF0dHJpYnV0ZSgnZGF0YS1zaG9wJyk7XG5cdFx0Y29uc3QgdXNlcl9pZCA9IGNhcmQuZ2V0QXR0cmlidXRlKCdkYXRhLXVzZXInKTtcblx0XHRjb25zdCBkYXRhID0ge1xuXHRcdFx0J2lkJzogaWQsXG5cdFx0XHQnbGlrZSc6IGxpa2UgfHwgdW5kZWZpbmVkLFxuXHRcdFx0J2Rpc2xpa2VkJzogZGlzbGlrZWQgfHwgdW5kZWZpbmVkLFxuXHRcdFx0J3VzZXJfaWQnOiB1c2VyX2lkXG5cdFx0fVxuXG5cdFx0Y29uc3Qgb3B0aW9ucyA9IHtcblx0XHRcdG1ldGhvZDogJ1BVVCcsXG5cdFx0XHRib2R5OiBKU09OLnN0cmluZ2lmeShkYXRhKSxcblx0XHRcdGhlYWRlcnM6IHsnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nfVxuXHRcdH07XG5cblx0XHRmZXRjaCh1cmwsIG9wdGlvbnMpXG5cdFx0XHQudGhlbihyZXMgPT4gcmVzLmpzb24oKSlcblx0XHRcdC50aGVuKHJlc3BvbnNlID0+IGNvbnNvbGUubG9nKHJlc3BvbnNlKSlcblx0XHRcdC5jYXRjaChlcnIgPT4gY29uc29sZS5sb2coZXJyKSk7XG5cdH1cbn1cblxubmV3IENhcmQoKTsiLCIndXNlIHN0cmljdCc7XHJcblxyXG5jbGFzcyBDYXJkT2ZmbGluZSB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLl9jYXJkcyA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmNhcmQnKSk7XHJcbiAgICAgICAgdGhpcy5faXNfbGlrZWQgPSAnY2FyZF9fYnV0dG9uX2lzLWxpa2VkJztcclxuICAgICAgICB0aGlzLl9pc19kaXNsaWtlZCA9ICdjYXJkX19idXR0b25faXMtZGlzbGlrZWQnO1xyXG4gICAgICAgIHRoaXMuX3N2Z19saWtlZCA9ICdzdmdfX2NhcmRfaXMtbGlrZWQnO1xyXG4gICAgICAgIHRoaXMuX3N2Z19kaXNsaWtlZCA9ICdzdmdfX2NhcmRfaXMtZGlzbGlrZWQnO1xyXG5cclxuICAgICAgICB0aGlzLl9hZGRFdmVudExpc3RlbmVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgX2FkZEV2ZW50TGlzdGVuZXIoKSB7XHJcbiAgICAgICAgdGhpcy5fY2FyZHMuZm9yRWFjaChjYXJkID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGhlX2J1dHRvbnMgPSBBcnJheS5mcm9tKGNhcmQucXVlcnlTZWxlY3RvckFsbCgnLmNhcmRfX2J1dHRvbicpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHRoaXMuX2hhbmRsZUNhcmQodGhlX2J1dHRvbnMsIGNhcmQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIF9oYW5kbGVDYXJkKGJ1dHRvbnMsIGNhcmQpIHtcclxuICAgICAgICBidXR0b25zLmZvckVhY2goYnV0dG9uID0+IHtcclxuICAgICAgICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgXyA9PiB0aGlzLl90b2dnbGVDYXJkQnV0dG9uKGJ1dHRvbiwgY2FyZCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIF90b2dnbGVDYXJkQnV0dG9uKGN1cnJlbnRfYnV0dG9uLCBjYXJkKSB7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRfYnV0dG9uLmNsYXNzTGlzdC5jb250YWlucygnY2FyZF9fYnV0dG9uX2Rpc2xpa2UnKSkge1xyXG4gICAgICAgICAgICB0aGlzLl9hZGRUb1N0b3JhZ2UoY3VycmVudF9idXR0b24sIGNhcmQsICdkaXNsaWtlZCcpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoY3VycmVudF9idXR0b24uY2xhc3NMaXN0LmNvbnRhaW5zKCdjYXJkX19idXR0b25fbGlrZScpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2FkZFRvU3RvcmFnZShjdXJyZW50X2J1dHRvbiwgY2FyZCwgJ2xpa2VkJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fYWRkVG9TdG9yYWdlKGN1cnJlbnRfYnV0dG9uLCBjYXJkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgX2FkZFRvU3RvcmFnZShidXR0b24sIGNhcmQsIHN0YXQpIHtcclxuICAgICAgICBjb25zdCB1cmwgPSBidXR0b24uZ2V0QXR0cmlidXRlKCdkYXRhLWhyZWYnKTtcclxuICAgICAgICBjb25zdCBjYXJkX2lkID0gY2FyZC5nZXRBdHRyaWJ1dGUoJ2RhdGEtc2hvcCcpO1xyXG4gICAgICAgIGNvbnN0IHVzZXJfaWQgPSBjYXJkLmdldEF0dHJpYnV0ZSgnZGF0YS11c2VyJyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgbGlrZXMgPSBuZXcgbGlrZXNEQigpO1xyXG5cclxuICAgICAgICBsaWtlcy5zZXQoe1xyXG4gICAgICAgICAgICAnaWQnOiBjYXJkX2lkLFxyXG4gICAgICAgICAgICAndXNlcl9pZCc6IHVzZXJfaWQsXHJcbiAgICAgICAgICAgICdzdGF0Jzogc3RhdCxcclxuICAgICAgICAgICAgJ3VybCc6IHVybFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59IiwiJ3VzZSBzdHJpY3QnO1xuXG5jbGFzcyBGaWx0ZXIge1xuXHRjb25zdHJ1Y3RvcigpIHtcblx0XHR0aGlzLl9idXR0b25zID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuZmlsdGVyX19idXR0b24nKSk7XG5cdFx0dGhpcy5fYWN0aXZlID0gJ2ZpbHRlcl9fYnV0dG9uX2FjdGl2ZSc7XG5cblx0XHR0aGlzLl9hZGRFdmVudExpc3RlbmVyKCk7XG5cdH1cblxuXHRfYWRkRXZlbnRMaXN0ZW5lcigpIHtcblx0XHR0aGlzLl9idXR0b25zLmZvckVhY2goYnV0dG9uID0+IHtcblx0XHRcdGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIF8gPT4gdGhpcy5fYWN0aXZhdGVCdXR0b24oYnV0dG9uKSk7XG5cdFx0fSk7XG5cdH1cblxuXHRfYWN0aXZhdGVCdXR0b24oY3VycmVudF9idXR0b24pIHtcblx0XHRpZiAoY3VycmVudF9idXR0b24uY2xhc3NMaXN0LmNvbnRhaW5zKHRoaXMuX2FjdGl2ZSkpIHJldHVybjtcblxuXHRcdC8vZGlzYWN0aXZhdGUgdGhlIG90aGVyIGJ1dHRvbnMuXG5cdFx0Y3VycmVudF9idXR0b24uY2xhc3NMaXN0LmFkZCh0aGlzLl9hY3RpdmUpO1xuXHRcdHRoaXMuX2J1dHRvbnMuZm9yRWFjaChidXR0b24gPT4ge1xuXHRcdFx0aWYgKGJ1dHRvbiAhPT0gY3VycmVudF9idXR0b24pIGJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKHRoaXMuX2FjdGl2ZSk7XG5cdFx0fSk7XG5cdH1cbn1cblxubmV3IEZpbHRlcigpOyIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmNsYXNzIGxpa2VzREIge1xyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5fZGIgPSBuZXcgRGV4aWUoJ015RGF0YWJhc2UnKTtcclxuICAgICAgICB0aGlzLl9kYi52ZXJzaW9uKDEpLnN0b3Jlcyh7bGlrZXM6ICcrK2RiX2lkLCBpZCwgdXNlcl9pZCwgbGlrZSwgZGlzbGlrZWQsIHVybCd9KTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQob2JqKSB7XHJcbiAgICAgICAgdGhpcy5fZGIub3BlbigpLnRoZW4oXyA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kYi5saWtlcy5hZGQoe1xyXG4gICAgICAgICAgICAgICAgaWQ6IG9iai5pZCxcclxuICAgICAgICAgICAgICAgIHVzZXJfaWQ6IG9iai51c2VyX2lkLFxyXG4gICAgICAgICAgICAgICAgbGlrZTogKG9iai5zdGF0ID09PSAnbGlrZWQnKSA/IG9iai5zdGF0IDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgZGlzbGlrZWQ6IChvYmouc3RhdCA9PT0gJ2Rpc2xpa2VkJykgPyBvYmouc3RhdCA6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgIHVybDogb2JqLnVybFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQoKSB7XHJcbiAgICAgICAgdGhpcy5fZGIub3BlbigpXHJcbiAgICAgICAgICAgIC50aGVuKF8gPT4gdGhpcy5fZGIubGlrZXMudG9BcnJheSgpKVxyXG4gICAgICAgICAgICAudGhlbihsaWtlcyA9PiBsaWtlcylcclxuICAgICAgICAgICAgLnRoZW4ocmVzdWx0cyA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdHMpIHJldHVybjtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgcmVzdWx0cy5mb3JFYWNoKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ2lkJzogcmVzdWx0LmlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAnbGlrZSc6IHJlc3VsdC5saWtlIHx8IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ2Rpc2xpa2VkJzogcmVzdWx0LmRpc2xpa2VkIHx8IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXJfaWQnOiByZXN1bHQudXNlcl9pZFxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BVVCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGRhdGEpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7J2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ31cclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBmZXRjaChyZXN1bHQudXJsLCBvcHRpb25zKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLmpzb24oKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gY29uc29sZS5sb2cocmVzcG9uc2UpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IGNvbnNvbGUubG9nKGVycikpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC50aGVuKF8gPT4gdGhpcy5fZGIubGlrZXMuY2xlYXIoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXIoKSB7XHJcbiAgICAgICAgdGhpcy5fZGIub3BlbigpLnRoZW4oXyA9PiB0aGlzLl9kYi5jbGVhcigpKTtcclxuICAgIH1cclxufSIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmNsYXNzIEZldGNoUGFnZSB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLl90cmlnZ2VycyA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmZldGNoJykpO1xyXG4gICAgICAgIHRoaXMuX3RhYnMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5uYXZfX3RhYicpKTtcclxuICAgICAgICB0aGlzLl9jb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubWFpbicpO1xyXG4gICAgICAgIHRoaXMuX3RtcF9jb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudG1wJyk7XHJcbiAgICAgICAgdGhpcy5fbG9hZGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmxvYWRlcicpO1xyXG4gICAgICAgIHRoaXMuX2NhcmRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuY2FyZCcpKTtcclxuXHJcbiAgICAgICAgdGhpcy5fYWRkRXZlbnRMaXN0ZW5lcigpO1xyXG4gICAgICAgIHRoaXMuX3JlZnJlc2godGhpcy5fY2FyZHMpO1xyXG4gICAgfVxyXG5cclxuICAgIF9hZGRFdmVudExpc3RlbmVyKCkge1xyXG4gICAgICAgIHRoaXMuX3RyaWdnZXJzLmZvckVhY2godHJpZ2dlciA9PiB7XHJcbiAgICAgICAgICAgIHRyaWdnZXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBldmVudCA9PiB0aGlzLl9nZXRQYWdlKGV2ZW50KSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgX2dldFBhZ2UoZXZlbnQpIHtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIHRoaXMuX2xvYWRlci5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTtcclxuXHJcbiAgICAgICAgY29uc3QgdHJpZ2dlciA9IGV2ZW50LnRhcmdldFxyXG4gICAgICAgIGNvbnN0IHVybCA9IHRyaWdnZXIuaHJlZjtcclxuICAgICAgICBjb25zdCBvcHRpb25zID0ge2NyZWRlbnRpYWxzOiBcInNhbWUtb3JpZ2luXCJ9XHJcblxyXG4gICAgICAgIGZldGNoKHVybCwgb3B0aW9ucylcclxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy50ZXh0KCkpXHJcbiAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3RtcF9jb250YWluZXIuaW5uZXJIVE1MID0gcmVzcG9uc2U7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVyKHRoaXMuX3RtcF9jb250YWluZXIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fbG9hZGVyLmNsYXNzTGlzdC5hZGQoJ2hpZGRlbicpO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuX3NldFRhYih0aGlzLl90YWJzLCB0cmlnZ2VyKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcclxuICAgIH1cclxuXHJcbiAgICBfcmVuZGVyKHRtcCkge1xyXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0bXAucXVlcnlTZWxlY3RvcignLm1haW4nKTtcclxuICAgICAgICB0aGlzLl9jb250YWluZXIuaW5uZXJIVE1MID0gXCJcIjtcclxuICAgICAgICB0aGlzLl9jb250YWluZXIuYXBwZW5kQ2hpbGQoY29udGVudCk7XHJcbiAgICAgICAgdGhpcy5fY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ3BhZ2VfX2lzLWFkZGVkJyk7XHJcblxyXG4gICAgICAgIHNldFRpbWVvdXQoXyA9PiB0aGlzLl9jb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgncGFnZV9faXMtYWRkZWQnKSwgNDAwKTtcclxuICAgICAgICBuZXcgQ2FyZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIF9zZXRUYWIodGFicywgY3VycmVudF90YWIpIHtcclxuICAgICAgICBpZiAoY3VycmVudF90YWIuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXZfX3RhYicpKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRfdGFiLmNsYXNzTGlzdC5hZGQoJ25hdl9fdGFiX2N1cnJlbnQnKTtcclxuICAgICAgICAgICAgdGFicy5mb3JFYWNoKHRhYiA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGFiICE9PSBjdXJyZW50X3RhYikgdGFiLmNsYXNzTGlzdC5yZW1vdmUoJ25hdl9fdGFiX2N1cnJlbnQnKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgX3JlZnJlc2goY2FyZHMpIHtcclxuICAgICAgICBpZiAoY2FyZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGZldGNoKCcvJylcclxuICAgICAgICAgICAgICAgIC50aGVuKHJlcyA9PiByZXMudGV4dCgpKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvYWRlci5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl90bXBfY29udGFpbmVyLmlubmVySFRNTCA9IHJlc3BvbnNlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXIodGhpcy5fdG1wX2NvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9hZGVyLmNsYXNzTGlzdC5hZGQoJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5uZXcgRmV0Y2hQYWdlKCk7IiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY2xhc3MgTWVudSB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLnNob3dCdXR0b25FbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5qcy1tZW51LXNob3cnKTtcclxuICAgICAgICB0aGlzLmhpZGVCdXR0b25FbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5qcy1tZW51LWhpZGUnKTtcclxuICAgICAgICB0aGlzLnNpZGVOYXZFbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5qcy1zaWRlLW5hdicpO1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkNvbnRhaW5lckVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmpzLXNpZGUtbmF2LWNvbnRhaW5lcicpO1xyXG5cclxuICAgICAgICB0aGlzLnNob3dTaWRlTmF2ID0gdGhpcy5zaG93U2lkZU5hdi5iaW5kKHRoaXMpO1xyXG4gICAgICAgIHRoaXMuaGlkZVNpZGVOYXYgPSB0aGlzLmhpZGVTaWRlTmF2LmJpbmQodGhpcyk7XHJcbiAgICAgICAgdGhpcy5ibG9ja0NsaWNrcyA9IHRoaXMuYmxvY2tDbGlja3MuYmluZCh0aGlzKTtcclxuICAgICAgICB0aGlzLm9uVG91Y2hTdGFydCA9IHRoaXMub25Ub3VjaFN0YXJ0LmJpbmQodGhpcyk7XHJcbiAgICAgICAgdGhpcy5vblRvdWNoTW92ZSA9IHRoaXMub25Ub3VjaE1vdmUuYmluZCh0aGlzKTtcclxuICAgICAgICB0aGlzLm9uVG91Y2hFbmQgPSB0aGlzLm9uVG91Y2hFbmQuYmluZCh0aGlzKTtcclxuICAgICAgICB0aGlzLm9uVHJhbnNpdGlvbkVuZCA9IHRoaXMub25UcmFuc2l0aW9uRW5kLmJpbmQodGhpcyk7XHJcbiAgICAgICAgdGhpcy51cGRhdGUgPSB0aGlzLnVwZGF0ZS5iaW5kKHRoaXMpO1xyXG5cclxuICAgICAgICB0aGlzLnN0YXJ0WCA9IDA7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50WCA9IDA7XHJcbiAgICAgICAgdGhpcy50b3VjaGluZ1NpZGVOYXYgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uRW5kUHJvcGVydHkgPSBudWxsO1xyXG4gICAgICAgIHRoaXMudHJhbnNpdGlvbkVuZFRpbWUgPSAwO1xyXG5cclxuICAgICAgICB0aGlzLnN1cHBvcnRzUGFzc2l2ZSA9IHVuZGVmaW5lZDtcclxuICAgICAgICB0aGlzLl9hZGRFdmVudExpc3RlbmVycygpO1xyXG4gICAgfVxyXG5cclxuICAgIGFwcGx5UGFzc2l2ZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5zdXBwb3J0c1Bhc3NpdmUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdXBwb3J0c1Bhc3NpdmUgPyB7IHBhc3NpdmU6IHRydWUgfSA6IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBsZXQgaXNTdXBwb3J0ZWQgPSBmYWxzZTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0ZXN0JywgbnVsbCwge1xyXG4gICAgICAgICAgICAgICAgZ2V0IHBhc3NpdmUoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7IH1cclxuICAgICAgICB0aGlzLnN1cHBvcnRzUGFzc2l2ZSA9IGlzU3VwcG9ydGVkO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmFwcGx5UGFzc2l2ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIF9hZGRFdmVudExpc3RlbmVycygpIHtcclxuICAgICAgICB0aGlzLnNob3dCdXR0b25FbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuc2hvd1NpZGVOYXYpO1xyXG4gICAgICAgIHRoaXMuaGlkZUJ1dHRvbkVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5oaWRlU2lkZU5hdik7XHJcbiAgICAgICAgdGhpcy5zaWRlTmF2RWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmhpZGVTaWRlTmF2KTtcclxuICAgICAgICB0aGlzLnNpZGVOYXZDb250YWluZXJFbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuYmxvY2tDbGlja3MpO1xyXG5cclxuICAgICAgICB0aGlzLnNpZGVOYXZFbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgdGhpcy5vblRvdWNoU3RhcnQsIHRoaXMuYXBwbHlQYXNzaXZlKCkpO1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMub25Ub3VjaE1vdmUsIHRoaXMuYXBwbHlQYXNzaXZlKCkpO1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5vblRvdWNoRW5kKTtcclxuICAgIH1cclxuXHJcbiAgICBvblRvdWNoU3RhcnQoZXZ0KSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnNpZGVOYXZFbC5jbGFzc0xpc3QuY29udGFpbnMoJ3NpZGUtbmF2LS12aXNpYmxlJykpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgdGhpcy5zdGFydFggPSBldnQudG91Y2hlc1swXS5wYWdlWDtcclxuICAgICAgICB0aGlzLmN1cnJlbnRYID0gdGhpcy5zdGFydFg7XHJcblxyXG4gICAgICAgIHRoaXMudG91Y2hpbmdTaWRlTmF2ID0gdHJ1ZTtcclxuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy51cGRhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVG91Y2hNb3ZlKGV2dCkge1xyXG4gICAgICAgIGlmICghdGhpcy50b3VjaGluZ1NpZGVOYXYpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgdGhpcy5jdXJyZW50WCA9IGV2dC50b3VjaGVzWzBdLnBhZ2VYO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVG91Y2hFbmQoZXZ0KSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnRvdWNoaW5nU2lkZU5hdilcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICB0aGlzLnRvdWNoaW5nU2lkZU5hdiA9IGZhbHNlO1xyXG5cclxuICAgICAgICBjb25zdCB0cmFuc2xhdGVYID0gTWF0aC5taW4oMCwgdGhpcy5jdXJyZW50WCAtIHRoaXMuc3RhcnRYKTtcclxuICAgICAgICB0aGlzLnNpZGVOYXZDb250YWluZXJFbC5zdHlsZS50cmFuc2Zvcm0gPSAnJztcclxuXHJcbiAgICAgICAgaWYgKHRyYW5zbGF0ZVggPCAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZVNpZGVOYXYoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlKCkge1xyXG4gICAgICAgIGlmICghdGhpcy50b3VjaGluZ1NpZGVOYXYpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMudXBkYXRlKTtcclxuXHJcbiAgICAgICAgY29uc3QgdHJhbnNsYXRlWCA9IE1hdGgubWluKDAsIHRoaXMuY3VycmVudFggLSB0aGlzLnN0YXJ0WCk7XHJcbiAgICAgICAgdGhpcy5zaWRlTmF2Q29udGFpbmVyRWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZVgoJHt0cmFuc2xhdGVYfXB4KWA7XHJcbiAgICB9XHJcblxyXG4gICAgYmxvY2tDbGlja3MoZXZ0KSB7XHJcbiAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVHJhbnNpdGlvbkVuZChldnQpIHtcclxuICAgICAgICBpZiAoZXZ0LnByb3BlcnR5TmFtZSAhPSB0aGlzLnRyYW5zaXRpb25FbmRQcm9wZXJ0eSAmJiBldnQuZWxhcHNlZFRpbWUgIT0gdGhpcy50cmFuc2l0aW9uRW5kVGltZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnRyYW5zaXRpb25FbmRQcm9wZXJ0eSA9IG51bGw7XHJcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uRW5kVGltZSA9IDA7XHJcblxyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmNsYXNzTGlzdC5yZW1vdmUoJ3NpZGUtbmF2LS1hbmltYXRhYmxlJyk7XHJcbiAgICAgICAgdGhpcy5zaWRlTmF2RWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIHRoaXMub25UcmFuc2l0aW9uRW5kKTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93U2lkZU5hdigpIHtcclxuICAgICAgICB0aGlzLnNpZGVOYXZFbC5jbGFzc0xpc3QuYWRkKCdzaWRlLW5hdi0tYW5pbWF0YWJsZScpO1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmNsYXNzTGlzdC5hZGQoJ3NpZGUtbmF2LS12aXNpYmxlJyk7XHJcblxyXG4gICAgICAgIHRoaXMudHJhbnNpdGlvbkVuZFByb3BlcnR5ID0gJ3RyYW5zZm9ybSc7XHJcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uRW5kVGltZSA9IDAuMzM7XHJcblxyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCB0aGlzLm9uVHJhbnNpdGlvbkVuZCk7XHJcbiAgICB9XHJcblxyXG4gICAgaGlkZVNpZGVOYXYoKSB7XHJcbiAgICAgICAgdGhpcy5zaWRlTmF2RWwuY2xhc3NMaXN0LmFkZCgnc2lkZS1uYXYtLWFuaW1hdGFibGUnKTtcclxuICAgICAgICB0aGlzLnNpZGVOYXZFbC5jbGFzc0xpc3QucmVtb3ZlKCdzaWRlLW5hdi0tdmlzaWJsZScpO1xyXG5cclxuICAgICAgICB0aGlzLnRyYW5zaXRpb25FbmRQcm9wZXJ0eSA9ICd0cmFuc2Zvcm0nO1xyXG4gICAgICAgIHRoaXMudHJhbnNpdGlvbkVuZFRpbWUgPSAwLjEzO1xyXG5cclxuICAgICAgICB0aGlzLnNpZGVOYXZFbC5hZGRFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgdGhpcy5vblRyYW5zaXRpb25FbmQpO1xyXG4gICAgfVxyXG59XHJcblxyXG5uZXcgTWVudSgpOyIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmlmICgnc2VydmljZVdvcmtlcicgaW4gbmF2aWdhdG9yKSB7XHJcbiAgICBhZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLnJlZ2lzdGVyKFxyXG4gICAgICAgICAgICAnL3N3LmpzJywgeyBzY29wZTogJy4nIH1cclxuICAgICAgICApO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmxldCBsb2NrID0gZmFsc2U7XHJcblxyXG5pZiAobmF2aWdhdG9yLm9uTGluZSkgYWRkRXZlbnRMaXN0ZW5lcignb25saW5lJywgXyA9PiBhcHBPbmxpbmUoKSk7XHJcbmVsc2UgYXBwT2ZmbGluZSgpO1xyXG5cclxuYWRkRXZlbnRMaXN0ZW5lcignb2ZmbGluZScsIF8gPT4gYXBwT2ZmbGluZSgpKTtcclxuYWRkRXZlbnRMaXN0ZW5lcignb25saW5lJywgXyA9PiBhcHBPbmxpbmUoKSk7XHJcblxyXG5mdW5jdGlvbiBhcHBPbmxpbmUoKSB7XHJcbiAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ29mZmxpbmUnKTtcclxuXHJcbiAgICBpZiAobG9jaykge1xyXG4gICAgICAgIGNvbnN0IGxpa2VzID0gbmV3IGxpa2VzREIoKTtcclxuICAgICAgICBsaWtlcy5nZXQoKTtcclxuICAgICAgICBsb2NrID0gZmFsc2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxvY2sgPSB0cnVlO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBhcHBPZmZsaW5lKCkge1xyXG4gICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdvZmZsaW5lJyk7XHJcbiAgICBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2EnKSkuZm9yRWFjaChsaW5rID0+IHtcclxuICAgICAgICBsaW5rSXNBdmFpbGFibGVPZmZsaW5lKGxpbmspLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlcykgbGluay5jbGFzc0xpc3QuYWRkKCdjYWNoZWQnKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIG5ldyBDYXJkT2ZmbGluZSgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsaW5rSXNBdmFpbGFibGVPZmZsaW5lKGxpbmspIHtcclxuICAgIGNvbnN0IHVybCA9IGxpbmsuaHJlZjtcclxuICAgIHJldHVybiBjYWNoZXMubWF0Y2godXJsKVxyXG4gICAgICAgIC50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbn0iXX0=
