'use strict';

class Card {
	constructor() {
		this._cards = Array.from(document.querySelectorAll('.card'));
		this._is_liked = 'card__button_is-liked';
		this._is_disliked = 'card__button_is-disliked';
		this._svg_liked = 'svg__card_is-liked';
		this._svg_disliked = 'svg__card_is-disliked';

		this._addEventListener();
	}

	_addEventListener() {
		this._cards.forEach(card => {
			const the_buttons = Array.from(card.querySelectorAll('.card__button'));
			
			this._handleCard(the_buttons, card);
		});
	}

	_handleCard(buttons, card) {
		buttons.forEach(button => {
			button.addEventListener('click', _ => this._toggleCardButton(button, buttons, card));
		});
	}

	_toggleCardButton(current_button, buttons, card) {
		if (current_button.classList.contains('card__button_dislike')) {
			this._removeCard(current_button, card, 'disliked');
		} else if (current_button.classList.contains('card__button_like')) {
			this._removeCard(current_button, card, 'liked');
		} else {
			this._removeCard(current_button, card);
		}
	}

	_removeCard(button, card, status) {
		const url = button.getAttribute('data-href');

		if (status === 'liked') this._cardStatus(url, card, status);
		else if (status === 'disliked') this._cardStatus(url, card, undefined, status);
		else this._cardStatus(url, card);

		card.classList.add('card__is-removed');
		setTimeout(_ => card.classList.add('hidden'), 400);
	}

	_cardStatus(url, card, like, disliked) {
		const id = card.getAttribute('data-shop');
		const user_id = card.getAttribute('data-user');
		const data = {
			'id': id,
			'like': like || undefined,
			'disliked': disliked || undefined,
			'user_id': user_id
		}

		const options = {
			method: 'PUT',
			body: JSON.stringify(data),
			headers: {'content-type': 'application/json'}
		};

		fetch(url, options)
			.then(res => res.json())
			.then(response => console.log(response))
			.catch(err => console.log(err));
	}
}

new Card();
'use strict';

class Filter {
	constructor() {
		this._buttons = Array.from(document.querySelectorAll('.filter__button'));
		this._active = 'filter__button_active';

		this._addEventListener();
	}

	_addEventListener() {
		this._buttons.forEach(button => {
			button.addEventListener('click', _ => this._activateButton(button));
		});
	}

	_activateButton(current_button) {
		if (current_button.classList.contains(this._active)) return;

		//disactivate the other buttons.
		current_button.classList.add(this._active);
		this._buttons.forEach(button => {
			if (button !== current_button) button.classList.remove(this._active);
		});
	}
}

new Filter();
'use strict';

class FetchPage {
    constructor() {
        this._triggers = Array.from(document.querySelectorAll('.fetch'));
        this._tabs = Array.from(document.querySelectorAll('.nav__tab'));
        this._container = document.querySelector('.main');
        this._tmp_container = document.querySelector('.tmp');
        this._loader = document.querySelector('.loader');
        this._cards = Array.from(document.querySelectorAll('.card'));

        this._addEventListener();
        this._refresh(this._cards);
    }

    _addEventListener() {
        this._triggers.forEach(trigger => {
            trigger.addEventListener('click', event => this._getPage(event));
        });
    }

    _getPage(event) {
        event.preventDefault();
        const trigger = event.target
        const url = trigger.href;


        fetch(url)
            .then(res => res.text())
            .then(response => {
                this._loader.classList.remove('hidden');
                this._tmp_container.innerHTML = response;

                this._render(this._tmp_container);
                this._loader.classList.add('hidden');

                this._setTab(this._tabs, trigger);
            })
            .catch(err => console.log(err));
    }

    _render(tmp) {
        const content = tmp.querySelector('.main');
        this._container.innerHTML = "";
        this._container.appendChild(content);
        this._container.classList.add('page__is-added');

        setTimeout(_ => this._container.classList.remove('page__is-added'), 400);
        new Card();
    }

    _setTab(tabs, current_tab) {
        if (current_tab.classList.contains('nav__tab')) {
            current_tab.classList.add('nav__tab_current');
            tabs.forEach(tab => {
                if (tab !== current_tab) tab.classList.remove('nav__tab_current')
            });
        }
    }

    _refresh(cards) {
        if (cards.length === 0) {
            fetch('/')
                .then(res => res.text())
                .then(response => {
                    this._loader.classList.remove('hidden');
                    this._tmp_container.innerHTML = response;

                    this._render(this._tmp_container);
                    this._loader.classList.add('hidden');
                });
        }
    }
}

new FetchPage();
'use strict';

class Menu {
    constructor() {
        this.showButtonEl = document.querySelector('.js-menu-show');
        this.hideButtonEl = document.querySelector('.js-menu-hide');
        this.sideNavEl = document.querySelector('.js-side-nav');
        this.sideNavContainerEl = document.querySelector('.js-side-nav-container');

        this.showSideNav = this.showSideNav.bind(this);
        this.hideSideNav = this.hideSideNav.bind(this);
        this.blockClicks = this.blockClicks.bind(this);
        this.onTouchStart = this.onTouchStart.bind(this);
        this.onTouchMove = this.onTouchMove.bind(this);
        this.onTouchEnd = this.onTouchEnd.bind(this);
        this.onTransitionEnd = this.onTransitionEnd.bind(this);
        this.update = this.update.bind(this);

        this.startX = 0;
        this.currentX = 0;
        this.touchingSideNav = false;

        this.transitionEndProperty = null;
        this.transitionEndTime = 0;

        this.supportsPassive = undefined;
        this._addEventListeners();
    }

    applyPassive() {
        if (this.supportsPassive !== undefined) {
            return this.supportsPassive ? { passive: true } : false;
        }
        
        let isSupported = false;
        try {
            document.addEventListener('test', null, {
                get passive() {
                    isSupported = true;
                }
            });
        } catch (e) { }
        this.supportsPassive = isSupported;
        return this.applyPassive();
    }

    _addEventListeners() {
        this.showButtonEl.addEventListener('click', this.showSideNav);
        this.hideButtonEl.addEventListener('click', this.hideSideNav);
        this.sideNavEl.addEventListener('click', this.hideSideNav);
        this.sideNavContainerEl.addEventListener('click', this.blockClicks);

        this.sideNavEl.addEventListener('touchstart', this.onTouchStart, this.applyPassive());
        this.sideNavEl.addEventListener('touchmove', this.onTouchMove, this.applyPassive());
        this.sideNavEl.addEventListener('touchend', this.onTouchEnd);
    }

    onTouchStart(evt) {
        if (!this.sideNavEl.classList.contains('side-nav--visible'))
            return;

        this.startX = evt.touches[0].pageX;
        this.currentX = this.startX;

        this.touchingSideNav = true;
        requestAnimationFrame(this.update);
    }

    onTouchMove(evt) {
        if (!this.touchingSideNav)
            return;

        this.currentX = evt.touches[0].pageX;
    }

    onTouchEnd(evt) {
        if (!this.touchingSideNav)
            return;

        this.touchingSideNav = false;

        const translateX = Math.min(0, this.currentX - this.startX);
        this.sideNavContainerEl.style.transform = '';

        if (translateX < 0) {
            this.hideSideNav();
        }
    }

    update() {
        if (!this.touchingSideNav)
            return;

        requestAnimationFrame(this.update);

        const translateX = Math.min(0, this.currentX - this.startX);
        this.sideNavContainerEl.style.transform = `translateX(${translateX}px)`;
    }

    blockClicks(evt) {
        evt.stopPropagation();
    }

    onTransitionEnd(evt) {
        if (evt.propertyName != this.transitionEndProperty && evt.elapsedTime != this.transitionEndTime) {
            return;
        }

        this.transitionEndProperty = null;
        this.transitionEndTime = 0;

        this.sideNavEl.classList.remove('side-nav--animatable');
        this.sideNavEl.removeEventListener('transitionend', this.onTransitionEnd);
    }

    showSideNav() {
        this.sideNavEl.classList.add('side-nav--animatable');
        this.sideNavEl.classList.add('side-nav--visible');

        this.transitionEndProperty = 'transform';
        this.transitionEndTime = 0.33;

        this.sideNavEl.addEventListener('transitionend', this.onTransitionEnd);
    }

    hideSideNav() {
        this.sideNavEl.classList.add('side-nav--animatable');
        this.sideNavEl.classList.remove('side-nav--visible');

        this.transitionEndProperty = 'transform';
        this.transitionEndTime = 0.13;

        this.sideNavEl.addEventListener('transitionend', this.onTransitionEnd);
    }
}

new Menu();
'use strict';

if ('serviceWorker' in navigator) {
    addEventListener('load', function () {
        navigator.serviceWorker.register(
            '/sw.js', { scope: '.' }
        );
    });
}

class likesDB {
    constructor() {
        this._db = new Dexie('MyDatabase');
        this._db.version(1).stores({likes: '++db_id, id, user_id, like, disliked, url'});
    }

    set(obj) {
        this._db.open().then(_ => {
            return this._db.likes.add({
                id: obj.id,
                user_id: obj.user_id,
                like: (obj.stat === 'liked') ? obj.stat : undefined,
                disliked: (obj.stat === 'disliked') ? obj.stat : undefined,
                url: obj.url
            });
        });
    }

    get() {
        this._db.open()
            .then(_ => this._db.likes.toArray())
            .then(likes => likes)
            .then(results => {
                if (!results) return;

                results.forEach(result => {
                    const data = {
                        'id': result.id,
                        'like': result.like || undefined,
                        'disliked': result.disliked || undefined,
                        'user_id': result.user_id
                    };

                    const options = {
                        method: 'PUT',
                        body: JSON.stringify(data),
                        headers: {'content-type': 'application/json'}
                    };

                    fetch(result.url, options)
                        .then(res => res.json())
                        .then(response => console.log(response))
                        .catch(err => console.log(err));
                });
            })
            .then(_ => this._db.likes.clear());
    }

    clear() {
        this._db.open().then(_ => this._db.clear());
    }
}

class CardOffline {
    constructor() {
        this._cards = Array.from(document.querySelectorAll('.card'));
        this._is_liked = 'card__button_is-liked';
        this._is_disliked = 'card__button_is-disliked';
        this._svg_liked = 'svg__card_is-liked';
        this._svg_disliked = 'svg__card_is-disliked';

        this._addEventListener();
    }

    _addEventListener() {
        this._cards.forEach(card => {
            const the_buttons = Array.from(card.querySelectorAll('.card__button'));
            
            this._handleCard(the_buttons, card);
        });
    }

    _handleCard(buttons, card) {
        buttons.forEach(button => {
            button.addEventListener('click', _ => this._toggleCardButton(button, card));
        });
    }

    _toggleCardButton(current_button, card) {
        if (current_button.classList.contains('card__button_dislike')) {
            this._addToStorage(current_button, card, 'disliked');
        } else if (current_button.classList.contains('card__button_like')) {
            this._addToStorage(current_button, card, 'liked');
        } else {
            this._addToStorage(current_button, card);
        }
    }

    _addToStorage(button, card, stat) {
        const url = button.getAttribute('data-href');
        const card_id = card.getAttribute('data-shop');
        const user_id = card.getAttribute('data-user');
        
        const likes = new likesDB();

        likes.set({
            'id': card_id,
            'user_id': user_id,
            'stat': stat,
            'url': url
        });
    }
}

if (navigator.onLine) {
    addEventListener('online', _ => document.body.classList.remove('offline'));
    const likes = new likesDB();
    likes.get();
} else {
    appOffline();
}

addEventListener('offline', _ => appOffline());
addEventListener('online', _ => {
    document.body.classList.remove('offline');
    const likes = new likesDB();
    likes.get();
});

function appOffline() {
    document.body.classList.add('offline');
    Array.from(document.querySelectorAll('a')).forEach(link => {
        linkIsAvailableOffline(link).then(res => {
            if (res) link.classList.add('cached');
        });
    });

    new CardOffline();
}

function linkIsAvailableOffline(link) {
    const url = link.href;
    return caches.match(url)
        .then(res => {
            if (res) {
                if (res.status === 200) return true;
            }
        });
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL2NhcmQuanMiLCJqcy9maWx0ZXIuanMiLCJqcy9tYWluLmpzIiwianMvbWVudS5qcyIsImpzL3NlcnZpY2Vfd29ya2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ZFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeElBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNsYXNzIENhcmQge1xuXHRjb25zdHJ1Y3RvcigpIHtcblx0XHR0aGlzLl9jYXJkcyA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmNhcmQnKSk7XG5cdFx0dGhpcy5faXNfbGlrZWQgPSAnY2FyZF9fYnV0dG9uX2lzLWxpa2VkJztcblx0XHR0aGlzLl9pc19kaXNsaWtlZCA9ICdjYXJkX19idXR0b25faXMtZGlzbGlrZWQnO1xuXHRcdHRoaXMuX3N2Z19saWtlZCA9ICdzdmdfX2NhcmRfaXMtbGlrZWQnO1xuXHRcdHRoaXMuX3N2Z19kaXNsaWtlZCA9ICdzdmdfX2NhcmRfaXMtZGlzbGlrZWQnO1xuXG5cdFx0dGhpcy5fYWRkRXZlbnRMaXN0ZW5lcigpO1xuXHR9XG5cblx0X2FkZEV2ZW50TGlzdGVuZXIoKSB7XG5cdFx0dGhpcy5fY2FyZHMuZm9yRWFjaChjYXJkID0+IHtcblx0XHRcdGNvbnN0IHRoZV9idXR0b25zID0gQXJyYXkuZnJvbShjYXJkLnF1ZXJ5U2VsZWN0b3JBbGwoJy5jYXJkX19idXR0b24nKSk7XG5cdFx0XHRcblx0XHRcdHRoaXMuX2hhbmRsZUNhcmQodGhlX2J1dHRvbnMsIGNhcmQpO1xuXHRcdH0pO1xuXHR9XG5cblx0X2hhbmRsZUNhcmQoYnV0dG9ucywgY2FyZCkge1xuXHRcdGJ1dHRvbnMuZm9yRWFjaChidXR0b24gPT4ge1xuXHRcdFx0YnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgXyA9PiB0aGlzLl90b2dnbGVDYXJkQnV0dG9uKGJ1dHRvbiwgYnV0dG9ucywgY2FyZCkpO1xuXHRcdH0pO1xuXHR9XG5cblx0X3RvZ2dsZUNhcmRCdXR0b24oY3VycmVudF9idXR0b24sIGJ1dHRvbnMsIGNhcmQpIHtcblx0XHRpZiAoY3VycmVudF9idXR0b24uY2xhc3NMaXN0LmNvbnRhaW5zKCdjYXJkX19idXR0b25fZGlzbGlrZScpKSB7XG5cdFx0XHR0aGlzLl9yZW1vdmVDYXJkKGN1cnJlbnRfYnV0dG9uLCBjYXJkLCAnZGlzbGlrZWQnKTtcblx0XHR9IGVsc2UgaWYgKGN1cnJlbnRfYnV0dG9uLmNsYXNzTGlzdC5jb250YWlucygnY2FyZF9fYnV0dG9uX2xpa2UnKSkge1xuXHRcdFx0dGhpcy5fcmVtb3ZlQ2FyZChjdXJyZW50X2J1dHRvbiwgY2FyZCwgJ2xpa2VkJyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuX3JlbW92ZUNhcmQoY3VycmVudF9idXR0b24sIGNhcmQpO1xuXHRcdH1cblx0fVxuXG5cdF9yZW1vdmVDYXJkKGJ1dHRvbiwgY2FyZCwgc3RhdHVzKSB7XG5cdFx0Y29uc3QgdXJsID0gYnV0dG9uLmdldEF0dHJpYnV0ZSgnZGF0YS1ocmVmJyk7XG5cblx0XHRpZiAoc3RhdHVzID09PSAnbGlrZWQnKSB0aGlzLl9jYXJkU3RhdHVzKHVybCwgY2FyZCwgc3RhdHVzKTtcblx0XHRlbHNlIGlmIChzdGF0dXMgPT09ICdkaXNsaWtlZCcpIHRoaXMuX2NhcmRTdGF0dXModXJsLCBjYXJkLCB1bmRlZmluZWQsIHN0YXR1cyk7XG5cdFx0ZWxzZSB0aGlzLl9jYXJkU3RhdHVzKHVybCwgY2FyZCk7XG5cblx0XHRjYXJkLmNsYXNzTGlzdC5hZGQoJ2NhcmRfX2lzLXJlbW92ZWQnKTtcblx0XHRzZXRUaW1lb3V0KF8gPT4gY2FyZC5jbGFzc0xpc3QuYWRkKCdoaWRkZW4nKSwgNDAwKTtcblx0fVxuXG5cdF9jYXJkU3RhdHVzKHVybCwgY2FyZCwgbGlrZSwgZGlzbGlrZWQpIHtcblx0XHRjb25zdCBpZCA9IGNhcmQuZ2V0QXR0cmlidXRlKCdkYXRhLXNob3AnKTtcblx0XHRjb25zdCB1c2VyX2lkID0gY2FyZC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdXNlcicpO1xuXHRcdGNvbnN0IGRhdGEgPSB7XG5cdFx0XHQnaWQnOiBpZCxcblx0XHRcdCdsaWtlJzogbGlrZSB8fCB1bmRlZmluZWQsXG5cdFx0XHQnZGlzbGlrZWQnOiBkaXNsaWtlZCB8fCB1bmRlZmluZWQsXG5cdFx0XHQndXNlcl9pZCc6IHVzZXJfaWRcblx0XHR9XG5cblx0XHRjb25zdCBvcHRpb25zID0ge1xuXHRcdFx0bWV0aG9kOiAnUFVUJyxcblx0XHRcdGJvZHk6IEpTT04uc3RyaW5naWZ5KGRhdGEpLFxuXHRcdFx0aGVhZGVyczogeydjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9XG5cdFx0fTtcblxuXHRcdGZldGNoKHVybCwgb3B0aW9ucylcblx0XHRcdC50aGVuKHJlcyA9PiByZXMuanNvbigpKVxuXHRcdFx0LnRoZW4ocmVzcG9uc2UgPT4gY29uc29sZS5sb2cocmVzcG9uc2UpKVxuXHRcdFx0LmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcblx0fVxufVxuXG5uZXcgQ2FyZCgpOyIsIid1c2Ugc3RyaWN0JztcblxuY2xhc3MgRmlsdGVyIHtcblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0dGhpcy5fYnV0dG9ucyA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmZpbHRlcl9fYnV0dG9uJykpO1xuXHRcdHRoaXMuX2FjdGl2ZSA9ICdmaWx0ZXJfX2J1dHRvbl9hY3RpdmUnO1xuXG5cdFx0dGhpcy5fYWRkRXZlbnRMaXN0ZW5lcigpO1xuXHR9XG5cblx0X2FkZEV2ZW50TGlzdGVuZXIoKSB7XG5cdFx0dGhpcy5fYnV0dG9ucy5mb3JFYWNoKGJ1dHRvbiA9PiB7XG5cdFx0XHRidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfID0+IHRoaXMuX2FjdGl2YXRlQnV0dG9uKGJ1dHRvbikpO1xuXHRcdH0pO1xuXHR9XG5cblx0X2FjdGl2YXRlQnV0dG9uKGN1cnJlbnRfYnV0dG9uKSB7XG5cdFx0aWYgKGN1cnJlbnRfYnV0dG9uLmNsYXNzTGlzdC5jb250YWlucyh0aGlzLl9hY3RpdmUpKSByZXR1cm47XG5cblx0XHQvL2Rpc2FjdGl2YXRlIHRoZSBvdGhlciBidXR0b25zLlxuXHRcdGN1cnJlbnRfYnV0dG9uLmNsYXNzTGlzdC5hZGQodGhpcy5fYWN0aXZlKTtcblx0XHR0aGlzLl9idXR0b25zLmZvckVhY2goYnV0dG9uID0+IHtcblx0XHRcdGlmIChidXR0b24gIT09IGN1cnJlbnRfYnV0dG9uKSBidXR0b24uY2xhc3NMaXN0LnJlbW92ZSh0aGlzLl9hY3RpdmUpO1xuXHRcdH0pO1xuXHR9XG59XG5cbm5ldyBGaWx0ZXIoKTsiLCIndXNlIHN0cmljdCc7XHJcblxyXG5jbGFzcyBGZXRjaFBhZ2Uge1xyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5fdHJpZ2dlcnMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5mZXRjaCcpKTtcclxuICAgICAgICB0aGlzLl90YWJzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcubmF2X190YWInKSk7XHJcbiAgICAgICAgdGhpcy5fY29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1haW4nKTtcclxuICAgICAgICB0aGlzLl90bXBfY29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnRtcCcpO1xyXG4gICAgICAgIHRoaXMuX2xvYWRlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5sb2FkZXInKTtcclxuICAgICAgICB0aGlzLl9jYXJkcyA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmNhcmQnKSk7XHJcblxyXG4gICAgICAgIHRoaXMuX2FkZEV2ZW50TGlzdGVuZXIoKTtcclxuICAgICAgICB0aGlzLl9yZWZyZXNoKHRoaXMuX2NhcmRzKTtcclxuICAgIH1cclxuXHJcbiAgICBfYWRkRXZlbnRMaXN0ZW5lcigpIHtcclxuICAgICAgICB0aGlzLl90cmlnZ2Vycy5mb3JFYWNoKHRyaWdnZXIgPT4ge1xyXG4gICAgICAgICAgICB0cmlnZ2VyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZXZlbnQgPT4gdGhpcy5fZ2V0UGFnZShldmVudCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIF9nZXRQYWdlKGV2ZW50KSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBjb25zdCB0cmlnZ2VyID0gZXZlbnQudGFyZ2V0XHJcbiAgICAgICAgY29uc3QgdXJsID0gdHJpZ2dlci5ocmVmO1xyXG5cclxuXHJcbiAgICAgICAgZmV0Y2godXJsKVxyXG4gICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLnRleHQoKSlcclxuICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fbG9hZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fdG1wX2NvbnRhaW5lci5pbm5lckhUTUwgPSByZXNwb25zZTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXIodGhpcy5fdG1wX2NvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2FkZXIuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5fc2V0VGFiKHRoaXMuX3RhYnMsIHRyaWdnZXIpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IGNvbnNvbGUubG9nKGVycikpO1xyXG4gICAgfVxyXG5cclxuICAgIF9yZW5kZXIodG1wKSB7XHJcbiAgICAgICAgY29uc3QgY29udGVudCA9IHRtcC5xdWVyeVNlbGVjdG9yKCcubWFpbicpO1xyXG4gICAgICAgIHRoaXMuX2NvbnRhaW5lci5pbm5lckhUTUwgPSBcIlwiO1xyXG4gICAgICAgIHRoaXMuX2NvbnRhaW5lci5hcHBlbmRDaGlsZChjb250ZW50KTtcclxuICAgICAgICB0aGlzLl9jb250YWluZXIuY2xhc3NMaXN0LmFkZCgncGFnZV9faXMtYWRkZWQnKTtcclxuXHJcbiAgICAgICAgc2V0VGltZW91dChfID0+IHRoaXMuX2NvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdwYWdlX19pcy1hZGRlZCcpLCA0MDApO1xyXG4gICAgICAgIG5ldyBDYXJkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgX3NldFRhYih0YWJzLCBjdXJyZW50X3RhYikge1xyXG4gICAgICAgIGlmIChjdXJyZW50X3RhYi5jbGFzc0xpc3QuY29udGFpbnMoJ25hdl9fdGFiJykpIHtcclxuICAgICAgICAgICAgY3VycmVudF90YWIuY2xhc3NMaXN0LmFkZCgnbmF2X190YWJfY3VycmVudCcpO1xyXG4gICAgICAgICAgICB0YWJzLmZvckVhY2godGFiID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0YWIgIT09IGN1cnJlbnRfdGFiKSB0YWIuY2xhc3NMaXN0LnJlbW92ZSgnbmF2X190YWJfY3VycmVudCcpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfcmVmcmVzaChjYXJkcykge1xyXG4gICAgICAgIGlmIChjYXJkcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgZmV0Y2goJy8nKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy50ZXh0KCkpXHJcbiAgICAgICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9hZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcF9jb250YWluZXIuaW5uZXJIVE1MID0gcmVzcG9uc2U7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlcih0aGlzLl90bXBfY29udGFpbmVyKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkZXIuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbm5ldyBGZXRjaFBhZ2UoKTsiLCIndXNlIHN0cmljdCc7XHJcblxyXG5jbGFzcyBNZW51IHtcclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMuc2hvd0J1dHRvbkVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmpzLW1lbnUtc2hvdycpO1xyXG4gICAgICAgIHRoaXMuaGlkZUJ1dHRvbkVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmpzLW1lbnUtaGlkZScpO1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmpzLXNpZGUtbmF2Jyk7XHJcbiAgICAgICAgdGhpcy5zaWRlTmF2Q29udGFpbmVyRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuanMtc2lkZS1uYXYtY29udGFpbmVyJyk7XHJcblxyXG4gICAgICAgIHRoaXMuc2hvd1NpZGVOYXYgPSB0aGlzLnNob3dTaWRlTmF2LmJpbmQodGhpcyk7XHJcbiAgICAgICAgdGhpcy5oaWRlU2lkZU5hdiA9IHRoaXMuaGlkZVNpZGVOYXYuYmluZCh0aGlzKTtcclxuICAgICAgICB0aGlzLmJsb2NrQ2xpY2tzID0gdGhpcy5ibG9ja0NsaWNrcy5iaW5kKHRoaXMpO1xyXG4gICAgICAgIHRoaXMub25Ub3VjaFN0YXJ0ID0gdGhpcy5vblRvdWNoU3RhcnQuYmluZCh0aGlzKTtcclxuICAgICAgICB0aGlzLm9uVG91Y2hNb3ZlID0gdGhpcy5vblRvdWNoTW92ZS5iaW5kKHRoaXMpO1xyXG4gICAgICAgIHRoaXMub25Ub3VjaEVuZCA9IHRoaXMub25Ub3VjaEVuZC5iaW5kKHRoaXMpO1xyXG4gICAgICAgIHRoaXMub25UcmFuc2l0aW9uRW5kID0gdGhpcy5vblRyYW5zaXRpb25FbmQuYmluZCh0aGlzKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZSA9IHRoaXMudXBkYXRlLmJpbmQodGhpcyk7XHJcblxyXG4gICAgICAgIHRoaXMuc3RhcnRYID0gMDtcclxuICAgICAgICB0aGlzLmN1cnJlbnRYID0gMDtcclxuICAgICAgICB0aGlzLnRvdWNoaW5nU2lkZU5hdiA9IGZhbHNlO1xyXG5cclxuICAgICAgICB0aGlzLnRyYW5zaXRpb25FbmRQcm9wZXJ0eSA9IG51bGw7XHJcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uRW5kVGltZSA9IDA7XHJcblxyXG4gICAgICAgIHRoaXMuc3VwcG9ydHNQYXNzaXZlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIHRoaXMuX2FkZEV2ZW50TGlzdGVuZXJzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgYXBwbHlQYXNzaXZlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnN1cHBvcnRzUGFzc2l2ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN1cHBvcnRzUGFzc2l2ZSA/IHsgcGFzc2l2ZTogdHJ1ZSB9IDogZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBpc1N1cHBvcnRlZCA9IGZhbHNlO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3Rlc3QnLCBudWxsLCB7XHJcbiAgICAgICAgICAgICAgICBnZXQgcGFzc2l2ZSgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc1N1cHBvcnRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgfVxyXG4gICAgICAgIHRoaXMuc3VwcG9ydHNQYXNzaXZlID0gaXNTdXBwb3J0ZWQ7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlQYXNzaXZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgX2FkZEV2ZW50TGlzdGVuZXJzKCkge1xyXG4gICAgICAgIHRoaXMuc2hvd0J1dHRvbkVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5zaG93U2lkZU5hdik7XHJcbiAgICAgICAgdGhpcy5oaWRlQnV0dG9uRWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmhpZGVTaWRlTmF2KTtcclxuICAgICAgICB0aGlzLnNpZGVOYXZFbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuaGlkZVNpZGVOYXYpO1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkNvbnRhaW5lckVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5ibG9ja0NsaWNrcyk7XHJcblxyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLm9uVG91Y2hTdGFydCwgdGhpcy5hcHBseVBhc3NpdmUoKSk7XHJcbiAgICAgICAgdGhpcy5zaWRlTmF2RWwuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcy5vblRvdWNoTW92ZSwgdGhpcy5hcHBseVBhc3NpdmUoKSk7XHJcbiAgICAgICAgdGhpcy5zaWRlTmF2RWwuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLm9uVG91Y2hFbmQpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVG91Y2hTdGFydChldnQpIHtcclxuICAgICAgICBpZiAoIXRoaXMuc2lkZU5hdkVsLmNsYXNzTGlzdC5jb250YWlucygnc2lkZS1uYXYtLXZpc2libGUnKSlcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICB0aGlzLnN0YXJ0WCA9IGV2dC50b3VjaGVzWzBdLnBhZ2VYO1xyXG4gICAgICAgIHRoaXMuY3VycmVudFggPSB0aGlzLnN0YXJ0WDtcclxuXHJcbiAgICAgICAgdGhpcy50b3VjaGluZ1NpZGVOYXYgPSB0cnVlO1xyXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLnVwZGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25Ub3VjaE1vdmUoZXZ0KSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnRvdWNoaW5nU2lkZU5hdilcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnRYID0gZXZ0LnRvdWNoZXNbMF0ucGFnZVg7XHJcbiAgICB9XHJcblxyXG4gICAgb25Ub3VjaEVuZChldnQpIHtcclxuICAgICAgICBpZiAoIXRoaXMudG91Y2hpbmdTaWRlTmF2KVxyXG4gICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgIHRoaXMudG91Y2hpbmdTaWRlTmF2ID0gZmFsc2U7XHJcblxyXG4gICAgICAgIGNvbnN0IHRyYW5zbGF0ZVggPSBNYXRoLm1pbigwLCB0aGlzLmN1cnJlbnRYIC0gdGhpcy5zdGFydFgpO1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkNvbnRhaW5lckVsLnN0eWxlLnRyYW5zZm9ybSA9ICcnO1xyXG5cclxuICAgICAgICBpZiAodHJhbnNsYXRlWCA8IDApIHtcclxuICAgICAgICAgICAgdGhpcy5oaWRlU2lkZU5hdigpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGUoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnRvdWNoaW5nU2lkZU5hdilcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy51cGRhdGUpO1xyXG5cclxuICAgICAgICBjb25zdCB0cmFuc2xhdGVYID0gTWF0aC5taW4oMCwgdGhpcy5jdXJyZW50WCAtIHRoaXMuc3RhcnRYKTtcclxuICAgICAgICB0aGlzLnNpZGVOYXZDb250YWluZXJFbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlWCgke3RyYW5zbGF0ZVh9cHgpYDtcclxuICAgIH1cclxuXHJcbiAgICBibG9ja0NsaWNrcyhldnQpIHtcclxuICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25UcmFuc2l0aW9uRW5kKGV2dCkge1xyXG4gICAgICAgIGlmIChldnQucHJvcGVydHlOYW1lICE9IHRoaXMudHJhbnNpdGlvbkVuZFByb3BlcnR5ICYmIGV2dC5lbGFwc2VkVGltZSAhPSB0aGlzLnRyYW5zaXRpb25FbmRUaW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudHJhbnNpdGlvbkVuZFByb3BlcnR5ID0gbnVsbDtcclxuICAgICAgICB0aGlzLnRyYW5zaXRpb25FbmRUaW1lID0gMDtcclxuXHJcbiAgICAgICAgdGhpcy5zaWRlTmF2RWwuY2xhc3NMaXN0LnJlbW92ZSgnc2lkZS1uYXYtLWFuaW1hdGFibGUnKTtcclxuICAgICAgICB0aGlzLnNpZGVOYXZFbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgdGhpcy5vblRyYW5zaXRpb25FbmQpO1xyXG4gICAgfVxyXG5cclxuICAgIHNob3dTaWRlTmF2KCkge1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmNsYXNzTGlzdC5hZGQoJ3NpZGUtbmF2LS1hbmltYXRhYmxlJyk7XHJcbiAgICAgICAgdGhpcy5zaWRlTmF2RWwuY2xhc3NMaXN0LmFkZCgnc2lkZS1uYXYtLXZpc2libGUnKTtcclxuXHJcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uRW5kUHJvcGVydHkgPSAndHJhbnNmb3JtJztcclxuICAgICAgICB0aGlzLnRyYW5zaXRpb25FbmRUaW1lID0gMC4zMztcclxuXHJcbiAgICAgICAgdGhpcy5zaWRlTmF2RWwuYWRkRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIHRoaXMub25UcmFuc2l0aW9uRW5kKTtcclxuICAgIH1cclxuXHJcbiAgICBoaWRlU2lkZU5hdigpIHtcclxuICAgICAgICB0aGlzLnNpZGVOYXZFbC5jbGFzc0xpc3QuYWRkKCdzaWRlLW5hdi0tYW5pbWF0YWJsZScpO1xyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmNsYXNzTGlzdC5yZW1vdmUoJ3NpZGUtbmF2LS12aXNpYmxlJyk7XHJcblxyXG4gICAgICAgIHRoaXMudHJhbnNpdGlvbkVuZFByb3BlcnR5ID0gJ3RyYW5zZm9ybSc7XHJcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uRW5kVGltZSA9IDAuMTM7XHJcblxyXG4gICAgICAgIHRoaXMuc2lkZU5hdkVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCB0aGlzLm9uVHJhbnNpdGlvbkVuZCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbm5ldyBNZW51KCk7IiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxuaWYgKCdzZXJ2aWNlV29ya2VyJyBpbiBuYXZpZ2F0b3IpIHtcclxuICAgIGFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoXHJcbiAgICAgICAgICAgICcvc3cuanMnLCB7IHNjb3BlOiAnLicgfVxyXG4gICAgICAgICk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuY2xhc3MgbGlrZXNEQiB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLl9kYiA9IG5ldyBEZXhpZSgnTXlEYXRhYmFzZScpO1xyXG4gICAgICAgIHRoaXMuX2RiLnZlcnNpb24oMSkuc3RvcmVzKHtsaWtlczogJysrZGJfaWQsIGlkLCB1c2VyX2lkLCBsaWtlLCBkaXNsaWtlZCwgdXJsJ30pO1xyXG4gICAgfVxyXG5cclxuICAgIHNldChvYmopIHtcclxuICAgICAgICB0aGlzLl9kYi5vcGVuKCkudGhlbihfID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2RiLmxpa2VzLmFkZCh7XHJcbiAgICAgICAgICAgICAgICBpZDogb2JqLmlkLFxyXG4gICAgICAgICAgICAgICAgdXNlcl9pZDogb2JqLnVzZXJfaWQsXHJcbiAgICAgICAgICAgICAgICBsaWtlOiAob2JqLnN0YXQgPT09ICdsaWtlZCcpID8gb2JqLnN0YXQgOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICBkaXNsaWtlZDogKG9iai5zdGF0ID09PSAnZGlzbGlrZWQnKSA/IG9iai5zdGF0IDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgdXJsOiBvYmoudXJsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCgpIHtcclxuICAgICAgICB0aGlzLl9kYi5vcGVuKClcclxuICAgICAgICAgICAgLnRoZW4oXyA9PiB0aGlzLl9kYi5saWtlcy50b0FycmF5KCkpXHJcbiAgICAgICAgICAgIC50aGVuKGxpa2VzID0+IGxpa2VzKVxyXG4gICAgICAgICAgICAudGhlbihyZXN1bHRzID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0cykgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgICAgIHJlc3VsdHMuZm9yRWFjaChyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdpZCc6IHJlc3VsdC5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ2xpa2UnOiByZXN1bHQubGlrZSB8fCB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdkaXNsaWtlZCc6IHJlc3VsdC5kaXNsaWtlZCB8fCB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICd1c2VyX2lkJzogcmVzdWx0LnVzZXJfaWRcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdQVVQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShkYXRhKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogeydjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZmV0Y2gocmVzdWx0LnVybCwgb3B0aW9ucylcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IGNvbnNvbGUubG9nKHJlc3BvbnNlKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAudGhlbihfID0+IHRoaXMuX2RiLmxpa2VzLmNsZWFyKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyKCkge1xyXG4gICAgICAgIHRoaXMuX2RiLm9wZW4oKS50aGVuKF8gPT4gdGhpcy5fZGIuY2xlYXIoKSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIENhcmRPZmZsaW5lIHtcclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMuX2NhcmRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuY2FyZCcpKTtcclxuICAgICAgICB0aGlzLl9pc19saWtlZCA9ICdjYXJkX19idXR0b25faXMtbGlrZWQnO1xyXG4gICAgICAgIHRoaXMuX2lzX2Rpc2xpa2VkID0gJ2NhcmRfX2J1dHRvbl9pcy1kaXNsaWtlZCc7XHJcbiAgICAgICAgdGhpcy5fc3ZnX2xpa2VkID0gJ3N2Z19fY2FyZF9pcy1saWtlZCc7XHJcbiAgICAgICAgdGhpcy5fc3ZnX2Rpc2xpa2VkID0gJ3N2Z19fY2FyZF9pcy1kaXNsaWtlZCc7XHJcblxyXG4gICAgICAgIHRoaXMuX2FkZEV2ZW50TGlzdGVuZXIoKTtcclxuICAgIH1cclxuXHJcbiAgICBfYWRkRXZlbnRMaXN0ZW5lcigpIHtcclxuICAgICAgICB0aGlzLl9jYXJkcy5mb3JFYWNoKGNhcmQgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0aGVfYnV0dG9ucyA9IEFycmF5LmZyb20oY2FyZC5xdWVyeVNlbGVjdG9yQWxsKCcuY2FyZF9fYnV0dG9uJykpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdGhpcy5faGFuZGxlQ2FyZCh0aGVfYnV0dG9ucywgY2FyZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgX2hhbmRsZUNhcmQoYnV0dG9ucywgY2FyZCkge1xyXG4gICAgICAgIGJ1dHRvbnMuZm9yRWFjaChidXR0b24gPT4ge1xyXG4gICAgICAgICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfID0+IHRoaXMuX3RvZ2dsZUNhcmRCdXR0b24oYnV0dG9uLCBjYXJkKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgX3RvZ2dsZUNhcmRCdXR0b24oY3VycmVudF9idXR0b24sIGNhcmQpIHtcclxuICAgICAgICBpZiAoY3VycmVudF9idXR0b24uY2xhc3NMaXN0LmNvbnRhaW5zKCdjYXJkX19idXR0b25fZGlzbGlrZScpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2FkZFRvU3RvcmFnZShjdXJyZW50X2J1dHRvbiwgY2FyZCwgJ2Rpc2xpa2VkJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50X2J1dHRvbi5jbGFzc0xpc3QuY29udGFpbnMoJ2NhcmRfX2J1dHRvbl9saWtlJykpIHtcclxuICAgICAgICAgICAgdGhpcy5fYWRkVG9TdG9yYWdlKGN1cnJlbnRfYnV0dG9uLCBjYXJkLCAnbGlrZWQnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9hZGRUb1N0b3JhZ2UoY3VycmVudF9idXR0b24sIGNhcmQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfYWRkVG9TdG9yYWdlKGJ1dHRvbiwgY2FyZCwgc3RhdCkge1xyXG4gICAgICAgIGNvbnN0IHVybCA9IGJ1dHRvbi5nZXRBdHRyaWJ1dGUoJ2RhdGEtaHJlZicpO1xyXG4gICAgICAgIGNvbnN0IGNhcmRfaWQgPSBjYXJkLmdldEF0dHJpYnV0ZSgnZGF0YS1zaG9wJyk7XHJcbiAgICAgICAgY29uc3QgdXNlcl9pZCA9IGNhcmQuZ2V0QXR0cmlidXRlKCdkYXRhLXVzZXInKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBsaWtlcyA9IG5ldyBsaWtlc0RCKCk7XHJcblxyXG4gICAgICAgIGxpa2VzLnNldCh7XHJcbiAgICAgICAgICAgICdpZCc6IGNhcmRfaWQsXHJcbiAgICAgICAgICAgICd1c2VyX2lkJzogdXNlcl9pZCxcclxuICAgICAgICAgICAgJ3N0YXQnOiBzdGF0LFxyXG4gICAgICAgICAgICAndXJsJzogdXJsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmlmIChuYXZpZ2F0b3Iub25MaW5lKSB7XHJcbiAgICBhZGRFdmVudExpc3RlbmVyKCdvbmxpbmUnLCBfID0+IGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnb2ZmbGluZScpKTtcclxuICAgIGNvbnN0IGxpa2VzID0gbmV3IGxpa2VzREIoKTtcclxuICAgIGxpa2VzLmdldCgpO1xyXG59IGVsc2Uge1xyXG4gICAgYXBwT2ZmbGluZSgpO1xyXG59XHJcblxyXG5hZGRFdmVudExpc3RlbmVyKCdvZmZsaW5lJywgXyA9PiBhcHBPZmZsaW5lKCkpO1xyXG5hZGRFdmVudExpc3RlbmVyKCdvbmxpbmUnLCBfID0+IHtcclxuICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnb2ZmbGluZScpO1xyXG4gICAgY29uc3QgbGlrZXMgPSBuZXcgbGlrZXNEQigpO1xyXG4gICAgbGlrZXMuZ2V0KCk7XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gYXBwT2ZmbGluZSgpIHtcclxuICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnb2ZmbGluZScpO1xyXG4gICAgQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdhJykpLmZvckVhY2gobGluayA9PiB7XHJcbiAgICAgICAgbGlua0lzQXZhaWxhYmxlT2ZmbGluZShsaW5rKS50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXMpIGxpbmsuY2xhc3NMaXN0LmFkZCgnY2FjaGVkJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBuZXcgQ2FyZE9mZmxpbmUoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gbGlua0lzQXZhaWxhYmxlT2ZmbGluZShsaW5rKSB7XHJcbiAgICBjb25zdCB1cmwgPSBsaW5rLmhyZWY7XHJcbiAgICByZXR1cm4gY2FjaGVzLm1hdGNoKHVybClcclxuICAgICAgICAudGhlbihyZXMgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG59Il19
